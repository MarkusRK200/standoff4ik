<!DOCTYPE html>
<html>
<head>
    <title>–≤–∞–Ω–µ–∫ —Å—Ç–∏–º—É–ª—è—Ç–æ—Ä</title>
    <!-- –î–æ–±–∞–≤–ª—è–µ–º Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #121212;
            color: white;
            text-align: center;
            padding: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .main-container {
            display: flex;
            width: 100%;
            max-width: 1200px;
        }

        .left-panel {
            width: 250px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 10px;
            margin-right: 20px;
        }

        .right-panel {
            flex-grow: 1;
        }

        .case-container {
            width: 300px;
            height: 150px;
            margin: 20px auto;
            overflow: hidden;
            position: relative;
            border: 3px solid #ff5500;
            border-radius: 10px;
        }

        .case-items {
            display: flex;
            position: absolute;
            left: 0;
            transition: transform 2s cubic-bezier(0.1, 0.7, 0.1, 1);
        }

        .case-item {
            min-width: 300px;
            height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            background: #1e1e1e;
            border-right: 1px solid #333;
        }

        .case-item img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        #result {
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
        }

        button {
            padding: 10px 20px;
            font-size: 18px;
            background: #ff5500;
            border: none;
            color: white;
            cursor: pointer;
            margin: 10px;
            border-radius: 5px;
            transition: all 0.2s;
        }

        button:hover {
            background: #ff7733;
            transform: translateY(-2px);
        }

        .rarity-common {
            color: #b0c3d9;
        }

        .rarity-rare {
            color: #5e98d9;
        }

        .rarity-epic {
            color: #8847ff;
        }

        .rarity-legendary {
            color: #eb4b4b;
        }

        .rarity-mythic {
            color: #ffd700;
            text-shadow: 0 0 10px gold;
        }

        /* –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º —Å–∫—Ä–æ–ª–ª–æ–º */
        .inventory {
            margin-top: 30px;
            padding: 15px;
            background: #1e1e1e;
            border-radius: 10px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            overflow: hidden;
            position: relative;
        }

        .inventory h2 {
            color: #ff5500;
            margin-top: 0;
            margin-bottom: 15px;
        }

        .inventory-container {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: #ff5500 #1e1e1e;
        }

        .inventory-container::-webkit-scrollbar {
            height: 8px;
        }

        .inventory-container::-webkit-scrollbar-track {
            background: #1e1e1e;
            border-radius: 10px;
        }

        .inventory-container::-webkit-scrollbar-thumb {
            background-color: #ff5500;
            border-radius: 10px;
        }

        .inventory-items {
            display: flex;
            gap: 10px;
            padding: 5px;
        }

        .inventory-item {
            background: #2a2a2a;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 0 0 auto;
            width: 80px;
        }

        .inventory-item img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            margin-bottom: 5px;
        }

        /* –ö–Ω–æ–ø–∫–∞ –º—É–∑—ã–∫–∏ */
        .music-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #ff5500;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.2s;
        }

        .music-control:hover {
            background: #ff7733;
            transform: scale(1.1);
        }

        /* –ö–Ω–æ–ø–∫–∞ –¥–æ–Ω–∞—Ç–∞ */
        .donate-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, #ff5500, #ff9900);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            cursor: pointer;
            z-index: 1000;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255, 85, 0, 0.4);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .donate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 85, 0, 0.6);
            background: linear-gradient(135deg, #ff9900, #ff5500);
        }

        .donate-btn:active {
            transform: translateY(1px);
        }

        .donate-btn::before {
            content: "üí∞";
            margin-right: 8px;
            font-size: 18px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .donate-btn.pulse {
            animation: pulse 1.5s infinite;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
        }

        .modal input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: none;
        }

        .leaderboard {
            margin-top: 20px;
            background: #1e1e1e;
            padding: 15px;
            border-radius: 10px;
        }

        .leaderboard h3 {
            color: #ff5500;
            margin-top: 0;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–Ω–ª–∞–π–Ω-–ª–µ–Ω—Ç—ã */
        .event-feed {
            position: fixed;
            bottom: 150px;
            left: 0;
            right: 0;
            background: rgba(30, 30, 30, 0.9);
            padding: 10px;
            border-top: 2px solid #ff5500;
            max-height: 100px;
            overflow-y: auto;
            z-index: 999;
        }

        .event-feed h3 {
            color: #ff5500;
            margin: 0 0 5px 0;
            text-align: center;
        }

        .event-item {
            padding: 5px;
            border-bottom: 1px solid #333;
            font-size: 14px;
            text-align: center;
        }

        .event-item span {
            color: #ff5500;
            font-weight: bold;
        }

        /* –î–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –æ–Ω–ª–∞–π–Ω-–ª–µ–Ω—Ç—ã */
        .event-feed::-webkit-scrollbar {
            width: 6px;
        }

        .event-feed::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        .event-feed::-webkit-scrollbar-thumb {
            background-color: #ff5500;
            border-radius: 3px;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ–Ω–ª–∞–π–Ω –∏–≥—Ä–æ–∫–æ–≤ */
        .online-users {
            margin-top: 15px;
            background: #1e1e1e;
            padding: 10px;
            border-radius: 10px;
        }

        .online-users h3 {
            color: #ff5500;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .online-user {
            padding: 3px 0;
            display: flex;
            align-items: center;
        }

        .online-user::before {
            content: "‚Ä¢";
            color: #4CAF50;
            font-weight: bold;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º:</p>
            <input type="text" id="usernameInput" placeholder="–í–∞—à –Ω–∏–∫" maxlength="15">
            <button onclick="registerUser()">–ù–∞—á–∞—Ç—å –∏–≥—Ä–∞—Ç—å</button>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div id="userInfo">
                <h3>–ò–≥—Ä–æ–∫: <span id="currentUser">–ì–æ—Å—Ç—å</span></h3>
                <p>–ü—Ä–æ–∫—Ä—É—Ç–æ–∫: <span id="userRolls">0</span></p>
                <p>–í—Ä–µ–º—è: <span id="userTime">0:00</span></p>
            </div>
            
            <div class="online-users">
                <h3>–û–Ω–ª–∞–π–Ω (<span id="onlineCount">0</span>)</h3>
                <div id="onlineUsersList"></div>
            </div>
            
            <div class="leaderboard">
                <h3>–¢–æ–ø –ø–æ –≤—Ä–µ–º–µ–Ω–∏</h3>
                <div id="timeLeaderboard">
                    <!-- –°—é–¥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ª–∏–¥–µ—Ä—ã -->
                </div>
            </div>
            
            <div class="leaderboard">
                <h3>–¢–æ–ø –ø–æ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞–º</h3>
                <div id="rollsLeaderboard">
                    <!-- –°—é–¥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ª–∏–¥–µ—Ä—ã -->
                </div>
            </div>
        </div>

        <div class="right-panel">
            <h1>–°–ò–ú–£–õ–Ø–¢–û–† –ö–ï–ô–°–û–í –û–¢ –í–ê–ù–ï–ö –∂–æ—Å–∫–∏–π</h1>

            <div class="case-container">
                <div class="case-items" id="caseItems"></div>
            </div>

            <div id="result">–ñ–º–∏ "–û—Ç–∫—Ä—ã—Ç—å"</div>
            <button onclick="startRoll()">–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å</button>
            <button onclick="reset()">–°–±—Ä–æ—Å–∏—Ç—å</button>

            <div class="inventory">
                <h2>–¢–≤–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å:</h2>
                <div class="inventory-container">
                    <div class="inventory-items" id="inventoryItems">
                        <!-- –°—é–¥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–µ–¥–º–µ—Ç—ã -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –û–Ω–ª–∞–π–Ω-–ª–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π -->
    <div class="event-feed">
        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h3>
        <div id="eventItems"></div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è -->
    <button class="donate-btn pulse" onclick="window.open('https://www.donationalerts.com/r/standoff_abuser', '_blank')">–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>

    <!-- –ö–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º—É–∑—ã–∫–æ–π -->
    <button class="music-control" onclick="toggleMusic()">üîä</button>

    <!-- –ê—É–¥–∏–æ -->
    <audio id="bgMusic" loop>
        <source src="https://trekson.net/uploads/files/pesnya-mango-mango-fonk.mp3" type="audio/mpeg">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç.
    </audio>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ—é)
        const firebaseConfig = {
            apiKey: "AIzaSyBdZsfvTIGZB7pA7LkpWzyMNhLmbg_oWvo",
            authDomain: "standof4ik-2c629.firebaseapp.com",
            databaseURL: "https://standof4ik-2c629-default-rtdb.firebaseio.com",
            projectId: "standof4ik-2c629",
            storageBucket: "standof4ik-2c629.firebasestorage.app",
            messagingSenderId: "101617540930",
            appId: "1:101617540930:web:6d75f2408bba28a47032db"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // –ë–∞–∑–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏
        const items = [
            {
                name: "–ü–∏—Å—Ç–æ–ª–µ—Ç '–û—á–∫–æ –ø–ª–∞—Ç–æ–Ω–∞'",
                rarity: "common",
                image: "images/ochk.png"
            },
            {
                name: "–î–∏–ª–¥–æ—Å '–ó–º–µ–π –≥–æ—Ä—ã–Ω—ã—á'",
                rarity: "rare",
                image: "images/dragon.png"
            },
            {
                name: "–ü—Ä–µ–∑–∏–∫–∏ '–ù–∞—Ç—è–Ω–∏ –º–æ–Ω–≥–æ–ª–∞'",
                rarity: "epic",
                image: "images/910.png"
            },
            {
                name: "AWP '–ö–æ–Ω—á–∞ –≤ –≥–ª–∞–∑—É'",
                rarity: "legendary",
                image: "images/glaz.png"
            },
            {
                name: "AK-47 '–î—Ä–æ—á—É –Ω–∞ –º–∞–º—É'",
                rarity: "common",
                image: "images/mama.png"
            },
            {
                name: "M4A1 '–¢—Ä—É—Å–∏–∫–∏ —Å –ø–æ–¥–ª–∏–≤–æ–π'",
                rarity: "rare",
                image: "images/podlv.png"
            },
            {
                name: "Deagle '—Ö–∑ –Ω–µ –ø—Ä–∏–¥—É–º–∞–ª'",
                rarity: "epic",
                image: "images/xz.png"
            },
            {
                name: "–ø–µ–Ω–∏—Å '–ö—Ä–∏–≤–æ–π'",
                rarity: "legendary",
                image: "images/kriv.png"
            },
            {
                name: "–∑–∞–ª—É–ø–∞ '—á–µ—Ä–Ω–∞—è(–Ω–µ–≥—Ä–∞)'",
                rarity: "mythic",
                image: "images/pramoy.png"
            },
            {
                name: "AWP '–î–º–∏—Ç—Ä–∏–π –ª–µ–≤–∫–æ–≤—Å–∫–∏'",
                rarity: "legendary",
                image: "images/dimas.png"
            },
            {
                name: "–°–∞–º–∏–π –∫—Ä—É—Ç–æ–π '–ú–µ–ª—Å—Ç—Ä–æ–πüíÄ'",
                rarity: "mythic",
                image: "images/mell.png"
            },
            {
                name: "–ú–ê–ù–ì–û '–ú–ê–ù–ì–û –ú–ê–ù–ì–û'",
                rarity: "legendary",
                image: "images/mango.png"
            },
            {
                name: "–≠–ª–∏—Ç–Ω—ã–π –ê–≥–µ–Ω—Ç '–î—ç–≤–∏–¥'",
                rarity: "epic",
                image: "images/dava.png"
            },
            {
                name: "–ø–ª–∞—Å—Ç–∏–Ω–∞ '–¢—Ä–æ–ª–ª—Ñ–µi—Å'",
                rarity: "legendary",
                image: "images/troll.png"
            },
            {
                name: "–≠–ª–∏—Ç–Ω—ã–π –ê–≥–µ–Ω—Ç '–°—Ç–µ–µ–µ–µ–ø–æ—á–∫–∏–Ω'",
                rarity: "rare",
                image: "images/stepa.png"
            },
            {
                name: "p90 '–ö–∞–∫–∞–Ω–¥—Ä–∏–∫'",
                rarity: "common",
                image: "images/kaka.png"
            },
            {
                name: "—Ö–∞–µ '–ü–∞—Ç—Ä–∏–∫'",
                rarity: "common",
                image: "images/patric.png"
            },
            {
                name: "—Å–ª–µ–ø–æ–≤–∞—è '–ì—É—Å—Ç–æ–π –ª–µ—Å'",
                rarity: "rare",
                image: "images/pot.png"
            },
            {
                name: "–ê–≥–µ–Ω—Ç '–ú—ç—Å—Åi'",
                rarity: "rare",
                image: "images/mess.png"
            }
        ];

        let currentUser = null;
        let userRolls = 0;
        let userTime = 0;
        let timeInterval;
        let userRef = null;
        let userOnlineRef = null;

        const caseItems = document.getElementById('caseItems');
        const inventoryItems = document.getElementById('inventoryItems');
        const eventItems = document.getElementById('eventItems');
        const bgMusic = document.getElementById('bgMusic');
        const registerModal = document.getElementById('registerModal');
        const usernameInput = document.getElementById('usernameInput');
        const currentUserSpan = document.getElementById('currentUser');
        const userRollsSpan = document.getElementById('userRolls');
        const userTimeSpan = document.getElementById('userTime');
        const timeLeaderboard = document.getElementById('timeLeaderboard');
        const rollsLeaderboard = document.getElementById('rollsLeaderboard');
        const onlineUsersList = document.getElementById('onlineUsersList');
        const onlineCount = document.getElementById('onlineCount');

        let isRolling = false;
        let finalItem;
        let userInventory = [];

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            const savedUser = localStorage.getItem('caseSimulatorCurrentUser');
            if (savedUser) {
                usernameInput.value = savedUser;
                registerUser();
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                registerModal.style.display = 'flex';
            }
            
            initCase();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –º—É–∑—ã–∫—É –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.body.addEventListener('click', function() {
                bgMusic.volume = 0.3;
                bgMusic.play().catch(e => console.log("–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –º—É–∑—ã–∫—É"));
            }, { once: true });

            // –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–æ–Ω–∞—Ç–∞
            document.querySelector('.donate-btn').addEventListener('mouseenter', function() {
                this.classList.add('pulse');
            });

            document.querySelector('.donate-btn').addEventListener('mouseleave', function() {
                this.classList.remove('pulse');
            });
        };

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function registerUser() {
            const username = usernameInput.value.trim();
            if (username) {
                currentUser = username;
                currentUserSpan.textContent = currentUser;
                localStorage.setItem('caseSimulatorCurrentUser', currentUser);
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                initializeUser();
                
                registerModal.style.display = 'none';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Firebase
        function initializeUser() {
            // –°—Å—ã–ª–∫–∞ –Ω–∞ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            userRef = database.ref('users/' + encodeUsername(currentUser));
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            userRef.once('value').then(snapshot => {
                const userData = snapshot.val();
                
                if (userData) {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
                    userRolls = userData.rolls || 0;
                    userRollsSpan.textContent = userRolls;
                    
                    userTime = userData.time || 0;
                    updateTimeDisplay();
                    
                    userInventory = userData.inventory || [];
                    updateInventory();
                } else {
                    // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - —Å–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
                    userRef.set({
                        name: currentUser,
                        rolls: 0,
                        time: 0,
                        inventory: []
                    });
                    
                    userRolls = 0;
                    userRollsSpan.textContent = userRolls;
                    
                    userTime = 0;
                    updateTimeDisplay();
                    
                    userInventory = [];
                    updateInventory();
                }
                
                // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏
                startTimeTracking();
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –æ–Ω–ª–∞–π–Ω –∏–≥—Ä–æ–∫–æ–≤
                setupOnlinePresence();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤
                loadLeaderboards();
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π
                subscribeToEvents();
            });
        }

        // –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∫–ª—é—á–∞
        function encodeUsername(username) {
            return username.replace(/\./g, ',').replace(/\$/g, ';').replace(/#/g, '@').replace(/\[/g, '(').replace(/\]/g, ')');
        }

        // –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function decodeUsername(encoded) {
            return encoded.replace(/,/g, '.').replace(/;/g, '$').replace(/@/g, '#').replace(/\(/g, '[').replace(/\)/g, ']');
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–Ω–ª–∞–π–Ω-–ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è
        function setupOnlinePresence() {
            // –°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            userOnlineRef = database.ref('online/' + encodeUsername(currentUser));
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å "–æ–Ω–ª–∞–π–Ω"
            userOnlineRef.set({
                name: currentUser,
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                userOnlineRef.update({
                    lastActive: firebase.database.ServerValue.TIMESTAMP
                });
            }, 15000);
            
            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            database.ref('online').on('value', snapshot => {
                const onlineUsers = [];
                const now = Date.now();
                
                snapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    // –°—á–∏—Ç–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–Ω–ª–∞–π–Ω, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥
                    if (now - userData.lastActive < 30000) {
                        onlineUsers.push({
                            name: userData.name,
                            lastActive: userData.lastActive
                        });
                    }
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                updateOnlineUsersList(onlineUsers);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateOnlineUsersList(users) {
            onlineUsersList.innerHTML = '';
            onlineCount.textContent = users.length;
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
            users.sort((a, b) => a.name.localeCompare(b.name));
            
            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'online-user';
                userElement.textContent = user.name;
                onlineUsersList.appendChild(userElement);
            });
        }

        // –ù–∞—á–∞–ª–æ –æ—Ç—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏
        function startTimeTracking() {
            clearInterval(timeInterval);
            timeInterval = setInterval(() => {
                userTime++;
                updateTimeDisplay();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                if (userRef) {
                    userRef.update({
                        time: userTime
                    });
                }
            }, 1000);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
        function updateTimeDisplay() {
            const minutes = Math.floor(userTime / 60);
            const seconds = userTime % 60;
            userTimeSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü –ª–∏–¥–µ—Ä–æ–≤
        function loadLeaderboards() {
            // –¢–æ–ø –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            database.ref('users').orderByChild('time').limitToLast(5).on('value', snapshot => {
                timeLeaderboard.innerHTML = '';
                const leaders = [];
                
                snapshot.forEach(userSnapshot => {
                    leaders.push(userSnapshot.val());
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –≤—Ä–µ–º–µ–Ω–∏
                leaders.sort((a, b) => b.time - a.time);
                
                leaders.forEach((player, index) => {
                    const minutes = Math.floor(player.time / 60);
                    const seconds = player.time % 60;
                    const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `
                        <span>${index + 1}. ${player.name}</span>
                        <span>${timeStr}</span>
                    `;
                    timeLeaderboard.appendChild(item);
                });
            });
            
            // –¢–æ–ø –ø–æ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞–º
            database.ref('users').orderByChild('rolls').limitToLast(5).on('value', snapshot => {
                rollsLeaderboard.innerHTML = '';
                const leaders = [];
                
                snapshot.forEach(userSnapshot => {
                    leaders.push(userSnapshot.val());
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –ø—Ä–æ–∫—Ä—É—Ç–æ–∫
                leaders.sort((a, b) => b.rolls - a.rolls);
                
                leaders.forEach((player, index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    item.innerHTML = `
                        <span>${index + 1}. ${player.name}</span>
                        <span>${player.rolls}</span>
                    `;
                    rollsLeaderboard.appendChild(item);
                });
            });
        }

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π
        function subscribeToEvents() {
            database.ref('events').limitToLast(20).on('value', snapshot => {
                eventItems.innerHTML = '';
                const events = [];
                
                snapshot.forEach(eventSnapshot => {
                    events.push(eventSnapshot.val());
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
                events.reverse().forEach(event => {
                    const eventElement = document.createElement('div');
                    eventElement.className = `event-item rarity-${event.rarity}`;
                    eventElement.innerHTML = `
                        [${event.time}] <span>${event.username}</span> –≤—ã–±–∏–ª ${event.itemName}
                    `;
                    eventItems.appendChild(eventElement);
                });
            });
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º—É–∑—ã–∫–æ–π
        function toggleMusic() {
            if (bgMusic.paused) {
                bgMusic.play();
                document.querySelector('.music-control').textContent = 'üîä';
            } else {
                bgMusic.pause();
                document.querySelector('.music-control').textContent = 'üîá';
            }
        }

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
        function initCase() {
            caseItems.innerHTML = '';
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–º–µ—Ç—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            for (let i = 0; i < 5; i++) {
                items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = `case-item rarity-${item.rarity}`;
                    
                    const imgElement = document.createElement('img');
                    imgElement.src = item.image;
                    imgElement.alt = item.name;
                    imgElement.onerror = function() {
                        this.src = 'https://via.placeholder.com/100?text=No+Image';
                    };
                    
                    const nameElement = document.createElement('span');
                    nameElement.textContent = item.name;
                    
                    itemElement.appendChild(imgElement);
                    itemElement.appendChild(nameElement);
                    caseItems.appendChild(itemElement);
                });
            }
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–∞ –≤—ã–ø–∞–≤—à–µ–º –ø—Ä–µ–¥–º–µ—Ç–µ
        function startRoll() {
            if (!currentUser) {
                registerModal.style.display = 'flex';
                return;
            }

            if (isRolling) return;
            isRolling = true;
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = "–ö—Ä—É—Ç–∏–º...";
            resultDiv.style.color = "white";

            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–æ–∫
            userRolls++;
            userRollsSpan.textContent = userRolls;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            if (userRef) {
                userRef.update({
                    rolls: userRolls
                });
            }

            // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç —Å —É—á–µ—Ç–æ–º —Ä–µ–¥–∫–æ—Å—Ç–∏
            const roll = Math.random();
            if (roll < 0.01) {
                finalItem = items.find(item => item.rarity === "mythic") || items[0];
            } else if (roll < 0.1) {
                const legendaryItems = items.filter(item => item.rarity === "legendary");
                finalItem = legendaryItems[Math.floor(Math.random() * legendaryItems.length)] || items[0];
            } else if (roll < 0.3) {
                const epicItems = items.filter(item => item.rarity === "epic");
                finalItem = epicItems[Math.floor(Math.random() * epicItems.length)] || items[0];
            } else if (roll < 0.6) {
                const rareItems = items.filter(item => item.rarity === "rare");
                finalItem = rareItems[Math.floor(Math.random() * rareItems.length)] || items[0];
            } else {
                const commonItems = items.filter(item => item.rarity === "common");
                finalItem = commonItems[Math.floor(Math.random() * commonItems.length)] || items[0];
            }

            // –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ
            const allItems = document.querySelectorAll('.case-item');
            let targetIndex = 0;
            for (let i = 0; i < allItems.length; i++) {
                if (allItems[i].querySelector('span').textContent === finalItem.name) {
                    targetIndex = i;
                    break;
                }
            }

            // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –ø—Ä–µ–¥–º–µ—Ç–µ
            const itemWidth = 300;
            const targetPosition = -targetIndex * itemWidth;
            const randomStart = -Math.floor(Math.random() * 1000) * itemWidth;

            caseItems.style.transform = `translateX(${randomStart}px)`;
            setTimeout(() => {
                caseItems.style.transform = `translateX(${targetPosition}px)`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                setTimeout(() => {
                    resultDiv.innerHTML = `–¢—ã –ø–æ–ª—É—á–∏–ª: <br><span class="rarity-${finalItem.rarity}">${finalItem.name}</span>`;
                    isRolling = false;

                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–º–µ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
                    addToInventory(finalItem);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ –ª–µ–Ω—Ç—É
                    addEvent(currentUser, finalItem.name, finalItem.rarity);
                }, 2000);
            }, 50);
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
        function addToInventory(item) {
            userInventory.push(item);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            if (userRef) {
                userRef.update({
                    inventory: userInventory
                });
            }
            
            updateInventory();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        function updateInventory() {
            inventoryItems.innerHTML = '';
            userInventory.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = `inventory-item rarity-${item.rarity}`;
                
                const imgElement = document.createElement('img');
                imgElement.src = item.image;
                imgElement.alt = item.name;
                imgElement.onerror = function() {
                    this.src = 'https://via.placeholder.com/50?text=No+Image';
                };
                
                const nameElement = document.createElement('span');
                nameElement.textContent = item.name;
                
                itemElement.appendChild(imgElement);
                itemElement.appendChild(nameElement);
                inventoryItems.appendChild(itemElement);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è
        function addEvent(username, itemName, rarity) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const event = {
                username: username,
                itemName: itemName,
                rarity: rarity,
                time: timeStr,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            database.ref('events').push(event);
        }

        function reset() {
            caseItems.style.transform = 'translateX(0)';
            document.getElementById('result').innerHTML = "–ñ–º–∏ '–û—Ç–∫—Ä—ã—Ç—å'";
        }

        // –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞ –æ–Ω–ª–∞–π–Ω
        window.addEventListener('beforeunload', function() {
            if (userOnlineRef) {
                userOnlineRef.remove();
            }
        });
    </script>
</body>
</html>